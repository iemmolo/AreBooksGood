{{ define "main" }}
  <h1 class="page-title">{{ .Title }}</h1>
  <div class="casino-intro">
    {{ .Content }}
  </div>

  <div class="casino-tile-grid">
    <a href="{{ "shops/pet-shop/" | relURL }}" class="casino-tile">
      <div class="casino-tile-visual">
        ğŸ± ğŸ‰<br>ğŸ¤–
      </div>
      <div class="casino-tile-pet"></div>
      <span class="casino-tile-label">> pet shop</span>
    </a>

    <a href="{{ "shops/silk-road/" | relURL }}" class="casino-tile">
      <div class="casino-tile-visual">
        ğŸŒ¿ ğŸ’°<br>ğŸšï¸
      </div>
      <div class="casino-tile-pet"></div>
      <span class="casino-tile-label">> silk road</span>
    </a>
  </div>

  <script>
  (function () {
    var PET_KEY = 'arebooksgood-pet';
    var SPRITE_SIZE = 16;
    var SCALE = 2;

    try {
      var raw = localStorage.getItem(PET_KEY);
      if (!raw) return;
      var ps = JSON.parse(raw);
      if (!ps.activePet || !ps.pets || !ps.pets[ps.activePet]) return;
      var petId = ps.activePet;
      var level = ps.pets[ps.activePet].level || 1;

      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/data/petsprites.json', true);
      xhr.onload = function () {
        if (xhr.status !== 200) return;
        var data;
        try { data = JSON.parse(xhr.responseText); } catch (e) { return; }

        var frames = resolveFrames(data, petId, level, 'idle');
        if (!frames || !frames.length) return;
        var grid = frames[0];

        var containers = document.querySelectorAll('.casino-tile-pet');
        for (var i = 0; i < containers.length; i++) {
          renderSprite(containers[i], grid);
        }
      };
      xhr.send();
    } catch (e) {}

    function resolveFrames(data, pid, lvl, anim) {
      var pd = data[pid];
      if (!pd) return null;
      var ld = pd[String(lvl)];
      if (!ld) return null;
      var f = ld[anim];
      if (typeof f === 'string') {
        if (f.indexOf('.') !== -1) {
          var p = f.split('.');
          return resolveFrames(data, p[0], parseInt(p[1], 10), anim);
        }
        return resolveFrames(data, pid, parseInt(f, 10), anim);
      }
      return f;
    }

    function renderSprite(container, grid) {
      var shadows = [];
      for (var i = 0; i < grid.length; i++) {
        if (grid[i] === 0) continue;
        var px = i % SPRITE_SIZE;
        var py = Math.floor(i / SPRITE_SIZE);
        var color = grid[i] === 1 ? 'var(--foreground)' : grid[i] === 3 ? 'var(--pet-accessory)' : 'var(--accent)';
        shadows.push((px * SCALE) + 'px ' + (py * SCALE) + 'px 0 0.5px ' + color);
      }
      var el = document.createElement('div');
      el.className = 'casino-tile-pet-pixel';
      el.style.width = SCALE + 'px';
      el.style.height = SCALE + 'px';
      el.style.boxShadow = shadows.join(',');
      container.appendChild(el);
    }
  })();
  </script>
{{ end }}
